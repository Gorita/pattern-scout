name: Check Upstream Updates

on:
  schedule:
    # ë§¤ì¼ ì •ì˜¤ 12:17 (KST) = ë§¤ì¼ 03:17 (UTC) - ì •ì‹œ í”¼í•´ì„œ ë¶€í•˜ ë¶„ì‚°
    - cron: '17 3 * * *'
  workflow_dispatch:

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/nibzard/awesome-agentic-patterns.git || true
          git fetch upstream main

      - name: Check for changes since last sync
        id: check
        run: |
          # Read last synced commit
          LAST_SYNC=""
          if [ -f ".last-upstream-sync" ]; then
            LAST_SYNC=$(cat .last-upstream-sync | tr -d '[:space:]')
          fi

          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          echo "Last synced: $LAST_SYNC"
          echo "Upstream HEAD: $UPSTREAM_COMMIT"

          # If no last sync record, or same commit, no updates
          if [ -z "$LAST_SYNC" ]; then
            echo "No .last-upstream-sync file found. Comparing all patterns by name."

            # Compare pattern files by name
            git ls-tree --name-only upstream/main patterns/ | grep '\.md$' | grep -v TEMPLATE | sed 's|patterns/||;s|\.md$||' | sort > /tmp/upstream_patterns.txt
            ls src/data/patterns/*.json 2>/dev/null | xargs -n1 basename | sed 's/\.json$//' | sort > /tmp/local_patterns.txt

            NEW_PATTERNS=$(comm -23 /tmp/upstream_patterns.txt /tmp/local_patterns.txt)

            if [ -z "$NEW_PATTERNS" ]; then
              echo "has_updates=false" >> $GITHUB_OUTPUT
              echo "All patterns are synced."
            else
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "has_new=true" >> $GITHUB_OUTPUT
              echo "has_modified=false" >> $GITHUB_OUTPUT

              NEW_COUNT=$(echo "$NEW_PATTERNS" | grep -c . || echo "0")
              echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT

              echo "new_patterns<<EOF" >> $GITHUB_OUTPUT
              echo "$NEW_PATTERNS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT

              echo "modified_patterns<<EOF" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          if [ "$LAST_SYNC" = "$UPSTREAM_COMMIT" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No new commits since last sync."
            exit 0
          fi

          # Check if last sync commit exists in upstream
          if ! git cat-file -e "$LAST_SYNC" 2>/dev/null; then
            echo "Last sync commit not found. Falling back to pattern name comparison."

            git ls-tree --name-only upstream/main patterns/ | grep '\.md$' | grep -v TEMPLATE | sed 's|patterns/||;s|\.md$||' | sort > /tmp/upstream_patterns.txt
            ls src/data/patterns/*.json 2>/dev/null | xargs -n1 basename | sed 's/\.json$//' | sort > /tmp/local_patterns.txt

            NEW_PATTERNS=$(comm -23 /tmp/upstream_patterns.txt /tmp/local_patterns.txt)

            if [ -z "$NEW_PATTERNS" ]; then
              echo "has_updates=false" >> $GITHUB_OUTPUT
            else
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "has_new=true" >> $GITHUB_OUTPUT
              echo "has_modified=false" >> $GITHUB_OUTPUT

              NEW_COUNT=$(echo "$NEW_PATTERNS" | grep -c . || echo "0")
              echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT

              echo "new_patterns<<EOF" >> $GITHUB_OUTPUT
              echo "$NEW_PATTERNS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT

              echo "modified_patterns<<EOF" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # Get changed pattern files since last sync
          CHANGED_FILES=$(git diff --name-only $LAST_SYNC..upstream/main -- 'patterns/*.md' | grep -v TEMPLATE || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No pattern changes since last sync."
            exit 0
          fi

          echo "has_updates=true" >> $GITHUB_OUTPUT

          # Separate new vs modified patterns
          # Get current local pattern names
          ls src/data/patterns/*.json 2>/dev/null | xargs -n1 basename | sed 's/\.json$//' | sort > /tmp/local_patterns.txt

          NEW_PATTERNS=""
          MODIFIED_PATTERNS=""

          for file in $CHANGED_FILES; do
            # Extract pattern name from path (patterns/name.md -> name)
            PATTERN_NAME=$(basename "$file" .md)

            if grep -q "^${PATTERN_NAME}$" /tmp/local_patterns.txt; then
              # Pattern exists locally - it's modified
              MODIFIED_PATTERNS="$MODIFIED_PATTERNS$PATTERN_NAME"$'\n'
            else
              # Pattern doesn't exist locally - it's new
              NEW_PATTERNS="$NEW_PATTERNS$PATTERN_NAME"$'\n'
            fi
          done

          # Remove trailing newlines
          NEW_PATTERNS=$(echo "$NEW_PATTERNS" | sed '/^$/d')
          MODIFIED_PATTERNS=$(echo "$MODIFIED_PATTERNS" | sed '/^$/d')

          # Count
          NEW_COUNT=0
          MODIFIED_COUNT=0
          [ -n "$NEW_PATTERNS" ] && NEW_COUNT=$(echo "$NEW_PATTERNS" | grep -c . || echo "0")
          [ -n "$MODIFIED_PATTERNS" ] && MODIFIED_COUNT=$(echo "$MODIFIED_PATTERNS" | grep -c . || echo "0")

          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "modified_count=$MODIFIED_COUNT" >> $GITHUB_OUTPUT

          [ -n "$NEW_PATTERNS" ] && echo "has_new=true" >> $GITHUB_OUTPUT || echo "has_new=false" >> $GITHUB_OUTPUT
          [ -n "$MODIFIED_PATTERNS" ] && echo "has_modified=true" >> $GITHUB_OUTPUT || echo "has_modified=false" >> $GITHUB_OUTPUT

          echo "new_patterns<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_PATTERNS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "modified_patterns<<EOF" >> $GITHUB_OUTPUT
          echo "$MODIFIED_PATTERNS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get commit log
          COMMIT_LOG=$(git log --oneline $LAST_SYNC..upstream/main --max-count=10)
          echo "commit_log<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          COMMIT_COUNT=$(git rev-list --count $LAST_SYNC..upstream/main)
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

      - name: Create Issue for Updates
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const hasNew = '${{ steps.check.outputs.has_new }}' === 'true';
            const hasModified = '${{ steps.check.outputs.has_modified }}' === 'true';
            const newCount = '${{ steps.check.outputs.new_count }}' || '0';
            const modifiedCount = '${{ steps.check.outputs.modified_count }}' || '0';
            const newPatterns = `${{ steps.check.outputs.new_patterns }}`.trim();
            const modifiedPatterns = `${{ steps.check.outputs.modified_patterns }}`.trim();
            const commitLog = `${{ steps.check.outputs.commit_log }}`.trim();
            const commitCount = '${{ steps.check.outputs.commit_count }}' || '?';
            const upstreamCommit = '${{ steps.check.outputs.upstream_commit }}';

            let title = 'ğŸ”„ Upstream ì—…ë°ì´íŠ¸: ';
            const parts = [];
            if (hasNew) parts.push(`ìƒˆ íŒ¨í„´ ${newCount}ê°œ`);
            if (hasModified) parts.push(`ìˆ˜ì •ëœ íŒ¨í„´ ${modifiedCount}ê°œ`);
            title += parts.join(', ');

            let body = `## ğŸ”„ Upstream ì—…ë°ì´íŠ¸ ê°ì§€

            upstream ì €ì¥ì†Œ([nibzard/awesome-agentic-patterns](https://github.com/nibzard/awesome-agentic-patterns))ì— ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.

            ### ğŸ“Š ìš”ì•½
            - **ìƒˆ ì»¤ë°‹ ìˆ˜**: ${commitCount}ê°œ
            - **ìƒˆ íŒ¨í„´**: ${newCount}ê°œ
            - **ìˆ˜ì •ëœ íŒ¨í„´**: ${modifiedCount}ê°œ
            - **ìµœì‹  ì»¤ë°‹**: \`${upstreamCommit.substring(0, 7)}\`
            `;

            if (hasNew && newPatterns) {
              body += `
            ### ğŸ†• ìƒˆ íŒ¨í„´ (${newCount}ê°œ)
            JSON íŒŒì¼ ìƒì„± + í•œêµ­ì–´ ë²ˆì—­ í•„ìš”

            \`\`\`
            ${newPatterns}
            \`\`\`
            `;
            }

            if (hasModified && modifiedPatterns) {
              body += `
            ### ğŸ“ ìˆ˜ì •ëœ íŒ¨í„´ (${modifiedCount}ê°œ)
            ì˜ì–´ í•„ë“œ ì—…ë°ì´íŠ¸ í•„ìš” (í•œêµ­ì–´ëŠ” ê²€í†  í›„ í•„ìš”ì‹œ ì¬ë²ˆì—­)

            \`\`\`
            ${modifiedPatterns}
            \`\`\`
            `;
            }

            if (commitLog) {
              body += `
            ### ğŸ“ ìµœê·¼ ì»¤ë°‹ ë¡œê·¸
            \`\`\`
            ${commitLog}
            \`\`\`
            `;
            }

            body += `
            ### ğŸ”§ ì‘ì—… ê°€ì´ë“œ

            #### ìƒˆ íŒ¨í„´ ì¶”ê°€
            1. upstreamì—ì„œ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ í™•ì¸
            2. JSON íŒŒì¼ ìƒì„± (\`src/data/patterns/{id}.json\`)
            3. í•œêµ­ì–´ ë²ˆì—­ ì¶”ê°€
            4. README íŒ¨í„´ ìˆ˜ ì—…ë°ì´íŠ¸

            #### ìˆ˜ì •ëœ íŒ¨í„´ ì—…ë°ì´íŠ¸
            1. upstream ë³€ê²½ ë‚´ìš© í™•ì¸: \`git diff <old>..<new> -- patterns/{name}.md\`
            2. í•´ë‹¹ JSON íŒŒì¼ì˜ ì˜ì–´ í•„ë“œ ì—…ë°ì´íŠ¸
            3. í•œêµ­ì–´ ë²ˆì—­ ê²€í†  (í•„ìš”ì‹œ ì¬ë²ˆì—­)

            #### ì™„ë£Œ í›„
            \`\`\`bash
            # .last-upstream-sync íŒŒì¼ ì—…ë°ì´íŠ¸
            echo "${upstreamCommit}" > .last-upstream-sync
            \`\`\`

            ---
            _ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ì—… ì™„ë£Œ í›„ ì´ìŠˆë¥¼ ë‹«ì•„ì£¼ì„¸ìš”._`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['upstream', 'sync']
            });

      - name: No Updates Found
        if: steps.check.outputs.has_updates == 'false'
        run: |
          echo "âœ… Upstream is up to date. No action needed."
