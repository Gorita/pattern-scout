name: Check Upstream Updates

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST) = ë§¤ì¼ ìì • (UTC)
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/nibzard/awesome-agentic-patterns.git || true
          git fetch upstream main

      - name: Check for new commits
        id: check
        run: |
          # Get the latest commit from upstream
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT

          # Check if this commit exists in our repo
          # Note: --is-ancestor returns exit code 1 if not ancestor, so we use || true
          if git merge-base --is-ancestor $UPSTREAM_COMMIT HEAD 2>/dev/null; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No new updates from upstream"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT

            # Try to get the common ancestor, fallback to comparing all commits if no common ancestor
            MERGE_BASE=$(git merge-base HEAD upstream/main 2>/dev/null || echo "")

            if [ -z "$MERGE_BASE" ]; then
              # No common ancestor - repositories are unrelated
              # Compare against the first commit of upstream
              echo "No common ancestor found, comparing full history"
              NEW_COMMITS=$(git rev-list --count upstream/main)
              CHANGED_FILES=$(git ls-tree -r --name-only upstream/main -- patterns/ | head -20)
              COMMIT_LOG=$(git log --oneline upstream/main --max-count=10)
            else
              # Normal case - common ancestor exists
              NEW_COMMITS=$(git rev-list --count $MERGE_BASE..upstream/main)
              CHANGED_FILES=$(git diff --name-only $MERGE_BASE..upstream/main -- patterns/ | head -20)
              COMMIT_LOG=$(git log --oneline $MERGE_BASE..upstream/main --max-count=10)
            fi

            echo "new_commits=$NEW_COMMITS" >> $GITHUB_OUTPUT

            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "commit_log<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMIT_LOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue for Updates
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const newCommits = '${{ steps.check.outputs.new_commits }}';
            const changedFiles = `${{ steps.check.outputs.changed_files }}`;
            const commitLog = `${{ steps.check.outputs.commit_log }}`;
            const upstreamCommit = '${{ steps.check.outputs.upstream_commit }}';

            const body = `## ğŸ”„ Upstream ì—…ë°ì´íŠ¸ ê°ì§€

            upstream ì €ì¥ì†Œ([nibzard/awesome-agentic-patterns](https://github.com/nibzard/awesome-agentic-patterns))ì— ìƒˆë¡œìš´ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.

            ### ğŸ“Š ìš”ì•½
            - **ìƒˆ ì»¤ë°‹ ìˆ˜**: ${newCommits}ê°œ
            - **ìµœì‹  ì»¤ë°‹**: \`${upstreamCommit.substring(0, 7)}\`
            - **í™•ì¸ ë§í¬**: [Compare changes](https://github.com/nibzard/awesome-agentic-patterns/compare/${upstreamCommit.substring(0, 7)}...main)

            ### ğŸ“ ìµœê·¼ ì»¤ë°‹ ë¡œê·¸
            \`\`\`
            ${commitLog}
            \`\`\`

            ### ğŸ“‚ ë³€ê²½ëœ íŒŒì¼ (patterns/ ë””ë ‰í† ë¦¬)
            ${changedFiles ? '```\n' + changedFiles + '\n```' : '_ë³€ê²½ëœ íŒ¨í„´ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤_'}

            ### ğŸ”§ ë‹¤ìŒ ë‹¨ê³„
            1. [upstream ì €ì¥ì†Œ](https://github.com/nibzard/awesome-agentic-patterns) í™•ì¸
            2. ìƒˆë¡œìš´ íŒ¨í„´ì´ ìˆë‹¤ë©´ CLAUDE.mdì˜ "upstreamì—ì„œ ìƒˆ íŒ¨í„´ ì¶”ê°€í•˜ê¸°" ê°€ì´ë“œ ì°¸ê³ 
            3. íŒ¨í„´ ë²ˆì—­ ë° JSON íŒŒì¼ ìƒì„±
            4. ë¹Œë“œ í…ŒìŠ¤íŠ¸ í›„ ì»¤ë°‹

            ---
            _ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ì—… ì™„ë£Œ í›„ ì´ìŠˆë¥¼ ë‹«ì•„ì£¼ì„¸ìš”._`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ Upstream ì—…ë°ì´íŠ¸ ê°ì§€',
              body: body,
              labels: ['upstream', 'sync']
            });

      - name: No Updates Found
        if: steps.check.outputs.has_updates == 'false'
        run: |
          echo "âœ… Upstream is up to date. No action needed."
