name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build with Astro
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: false

      - name: Comment on related issues
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const commitMsg = execSync('git log -1 --pretty=%B').toString();

            const issuePattern = /(?:closes|fixes|resolves)\s+#(\d+)/gi;
            const matches = [...commitMsg.matchAll(issuePattern)];

            if (matches.length === 0) {
              console.log('No issue references found in commit message');
              return;
            }

            const deployUrl = 'https://gorita.github.io/pattern-scout/';
            const commitSha = context.sha.substring(0, 7);
            const deployTime = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

            for (const match of matches) {
              const issueNumber = parseInt(match[1]);

              const body = [
                '## ✅ 배포 완료',
                '',
                '이 이슈와 관련된 변경사항이 배포되었습니다.',
                '',
                '- **배포 URL**: ' + deployUrl,
                '- **커밋**: `' + commitSha + '`',
                '- **배포 시간**: ' + deployTime,
                '',
                '---',
                '_이 코멘트는 자동으로 생성되었습니다._'
              ].join('\n');

              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: body
                });
                console.log('Commented on issue #' + issueNumber);
              } catch (error) {
                console.log('Failed to comment on issue #' + issueNumber + ': ' + error.message);
              }
            }
